

<form id="kiosk-form" class="row g-3 align-items-end">
  <div class="col-sm-3">
    <label class="form-label">Nº OB</label>
    <input required type="number" min="1" class="form-control" name="user_id" autofocus>
  </div>
  <div class="col-sm-2">
    <button id="btn-validate"
        class="btn btn-dark w-100"
        data-active="{{ 1 if current_meal else 0 }}"
        {% if not current_meal %}disabled{% endif %}>
  Validar
</button>
  </div>
</form>

<!-- feedback -->
<div id="result-box" class="mt-4 p-4 text-center rounded d-none"></div>

<!-- Sons (ficheiros curtos .mp3/.m4a; podes trocar os src) -->
<audio id="snd-ok"  src="{{ url_for('static', filename='static/temref.mp3') }}"  preload="auto" playsinline></audio>
<audio id="snd-bad" src="{{ url_for('static', filename='sounds/naotemref.mp3') }}" preload="auto" playsinline></audio>

<script>
(function () {
  const form = document.getElementById('kiosk-form');
  const btn  = document.getElementById('btn-validate');
  const box  = document.getElementById('result-box');
  const ok   = document.getElementById('snd-ok');
  const bad  = document.getElementById('snd-bad');
const hasActive = btn.dataset.active === '1';
if (!hasActive) return;
  // iOS/Safari “unlock”: primeira interação tenta tocar 1 ms de silêncio
  let audioPrimed = false;
  function primeAudio() {
    if (audioPrimed) return;
    audioPrimed = true;
    ok.play().then(() => { ok.pause(); ok.currentTime = 0; }).catch(()=>{});
    bad.play().then(() => { bad.pause(); bad.currentTime = 0; }).catch(()=>{});
  }
  window.addEventListener('touchstart', primeAudio, { once:true });
  window.addEventListener('click',      primeAudio, { once:true });

  function showMsg(kind, text) {
    box.className = 'mt-4 p-4 text-center rounded';
    if (kind === 'green') {
      box.classList.add('bg-success','text-white');
    } else {
      box.classList.add('bg-danger','text-white');
    }
    box.textContent = text;
    box.classList.remove('d-none');
  }

  form.addEventListener('submit', (e) => e.preventDefault());
  btn.addEventListener('click', async (e) => {
    e.preventDefault();

    // bloqueia botão enquanto valida
    btn.disabled = true;

    try {
      const fd = new FormData(form);
      const res = await fetch('{{ url_for("routes.kiosk") }}', {
        method: 'POST',
        headers: { 'X-Requested-With': 'XMLHttpRequest' },
        body: fd
      });
      const data = await res.json(); // {result:'green'|'red', msg:'...', current_meal:{...}}

      // toca som conforme resultado
      if (data.result === 'green') {
        ok.currentTime = 0;
        ok.play().catch(()=>{});
        showMsg('green', data.msg || 'Presença registada.');
        // cooldown 5s depois de SUCESSO
        setTimeout(() => { btn.disabled = false; }, 5000);
      } else {
        bad.currentTime = 0;
        bad.play().catch(()=>{});
        showMsg('red', data.msg || 'Sem reserva válida.');
        // sem cooldown longo no erro (podes trocar para 1s, por ex.)
        setTimeout(() => { btn.disabled = false; }, 1000);
      }
    } catch (err) {
      bad.currentTime = 0;
      bad.play().catch(()=>{});
      showMsg('red', 'Erro de rede. Tenta novamente.');
      setTimeout(() => { btn.disabled = false; }, 1000);
    }
  });
})();
</script>
